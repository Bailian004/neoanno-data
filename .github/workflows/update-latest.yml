name: Update latest manifest

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update versions/latest.json
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [ -z "$TAG" ]; then
            echo "No tag_name found"; exit 1
          fi

          mkdir -p versions

          # If file doesn't exist, create a minimal one
          if [ ! -f versions/latest.json ]; then
            echo '{}' > versions/latest.json
          fi

          node - <<'NODE'
          const fs = require('fs');
          const path = 'versions/latest.json';
          const tag = process.env.TAG;
          const json = JSON.parse(fs.readFileSync(path, 'utf8') || '{}');

          json.anno1800 = json.anno1800 || {};
          json.anno1800.latest = tag;
          json.anno1800.recommended = tag;

          // Optional: enforce min app version policy
          // json.anno1800.minAppVersion = "0.9.0";

          fs.writeFileSync(path, JSON.stringify(json, null, 2) + "\n");
          console.log(`Updated ${path} -> anno1800.latest=${tag}`);
          NODE
        env:
          TAG: ${{ github.event.release.tag_name }}

      - name: Commit and push
        shell: bash
        run: |
          git config user.name "neoanno-bot"
          git config user.email "neoanno-bot@users.noreply.github.com"
          git add versions/latest.json
          git commit -m "chore(data): set latest anno1800 to ${{ github.event.release.tag_name }}" || exit 0
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push origin HEAD:main
